@page "/create"
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService
@inject EditJobApplicationState State

@using System.Net.Http.Json;
@using System.Text.Json

<PageTitle>Create Job Application</PageTitle>

<RadzenText TextStyle="TextStyle.DisplayH3">Create Job Application</RadzenText>

@if (hasError)
{
    <RadzenProblemDetails Problem="problemDetails" />
}

<RadzenTemplateForm TItem="JobApplication" Data=@jobApplication Submit=@OnSubmit InvalidSubmit=@OnInvalidSubmit>
    <RadzenFieldset Text="Job Application" Data="@jobApplication">
        <RadzenStack Gap="1rem">
            <RadzenRow AlignItems="AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="2">
                    <RadzenLabel Text="Job Id" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="2">
                    <RadzenTextBox Name="JobId" @bind-Value="jobApplication.JobId" MaxLength="50" Disabled="@isBusy" class="w-100" />
                    <RadzenRequiredValidator Text="Job Id is required" Component="JobId" Popup="true" Style="position: absolute" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow AlignItems="AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="2">
                    <RadzenLabel Text="Contact Name" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenTextBox Name="ContactName" @bind-Value="jobApplication.ContactName" MaxLength="50" Disabled="@isBusy" class="w-100" />
                    <RadzenRequiredValidator Text="Contact Name is required" Component="ContactName" Popup="true" Style="position: absolute" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow AlignItems="AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenLabel Text="Url" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="optional" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="9">
                    <RadzenTextBox Name="Url" @bind-Value="jobApplication.Url" MaxLength="255" Disabled="@isBusy" class="w-100" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow AlignItems="AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenLabel Text="Job Ref" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="optional" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="2">
                    <RadzenTextBox Name="JobRef" @bind-Value="jobApplication.JobRef" MaxLength="50" Disabled="@isBusy" class="w-100" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow AlignItems="AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenLabel Text="Telephone" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="optional" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="2">
                    <RadzenTextBox Name="Telephone" @bind-Value="jobApplication.Telephone" MaxLength="50" Disabled="@isBusy" class="w-100" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow AlignItems="AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenLabel Text="Email" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="optional" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenTextBox Name="Email" @bind-Value="jobApplication.Email" MaxLength="100" Disabled="@isBusy" class="w-100" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow AlignItems="AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenLabel Text="Company" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="optional" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="2">
                    <RadzenTextBox Name="Company" @bind-Value="jobApplication.Company" MaxLength="50" Disabled="@isBusy" class="w-100" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow AlignItems="AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenLabel Text="Notes" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="1">
                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="optional" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="10">
                    <RadzenTextArea Name="Notes" @bind-Value="jobApplication.Notes" Rows="5" class="w-100" />
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </RadzenFieldset>

    <RadzenStack 
        Orientation="Orientation.Horizontal"
        AlignItems="AlignItems.Start"
        JustifyContent="JustifyContent.Left"
        Gap="1rem"
        Wrap="FlexWrap.Wrap"
        class="rz-py-6"
    >
        <RadzenButton style="width: 120px" IsBusy=@isBusy Click=@Cancel Text="Cancel" />
        <RadzenButton ButtonType="ButtonType.Submit" style="width: 120px" Icon="save" BusyText="Saving" IsBusy=@isBusy Text="Save" />
    </RadzenStack>
</RadzenTemplateForm>

@code {
    JobApplication jobApplication = new();
    bool isBusy;
    bool hasError;
    ProblemDetails? problemDetails;

    void Cancel()
    {
        NavigationManager.NavigateTo("/");
    }

    void OnInvalidSubmit(FormInvalidSubmitEventArgs args)
    {
        Console.WriteLine(args);
    }

    async Task OnSubmit(JobApplication mode)
    {
        try
        {
            hasError = false;
            isBusy = true;

            var response = await HttpClient.PostAsJsonAsync("https://localhost:7176/api/jobapplication", jobApplication);

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(new NotificationMessage { 
                    Severity = NotificationSeverity.Info,
                    Summary = "Success", 
                    Detail = "Job Application Created" });

                NavigationManager.NavigateTo("/");
                return;
            }

            problemDetails = await JsonSerializer.DeserializeAsync<ProblemDetails>(await response.Content.ReadAsStreamAsync(), new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }

        isBusy = false;
        hasError = true;
    }
}